"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.reroll = exports.damageRoll = exports.psychicRoll = exports.weaponRoll = exports.commonRoll = void 0;
async function commonRoll(rollData) {
    _rollPoolDice(rollData);
    _computeChat(rollData);
    await _sendToChat(rollData);
}
exports.commonRoll = commonRoll;
async function weaponRoll(rollData) {
    let weaponName = rollData.name;
    rollData.name = game.i18n.localize(rollData.skillName);
    await commonRoll(rollData);
    rollData.name = weaponName;
    if (rollData.result.isSuccess) {
        _rollDamage(rollData);
        _computeDamageChat(rollData);
        await _sendDamageToChat(rollData);
    }
}
exports.weaponRoll = weaponRoll;
async function psychicRoll(rollData) {
    let psychicName = rollData.name;
    rollData.name = game.i18n.localize(rollData.skillName);
    await commonRoll(rollData);
    rollData.name = psychicName;
    if (rollData.result.isSuccess && _hasDamage(rollData)) {
        _rollDamage(rollData);
        _computeDamageChat(rollData);
        await _sendDamageToChat(rollData);
    }
}
exports.psychicRoll = psychicRoll;
async function damageRoll(rollData) {
    _rollDamage(rollData);
    _computeDamageChat(rollData);
    await _sendDamageToChat(rollData);
}
exports.damageRoll = damageRoll;
async function reroll(rollData) {
    rollData.rolls.hit = [];
    rollData.result.dice = rollData.result.dice.map(die => {
        if (die.rerollable) {
            let r = new Roll("1d6", {}).evaluate();
            rollData.rolls.hit.push(r);
            if (die.isWrath) {
                return _computeWrath(r.total);
            }
            else {
                return _computeDice(r.total);
            }
        }
        else {
            return die;
        }
    });
    _computeChat(rollData);
    await _sendToChat(rollData);
}
exports.reroll = reroll;
function _rollPoolDice(rollData) {
    let wrathSize = rollData.wrath.base > 0 ? rollData.wrath.base : 1;
    let poolSize = rollData.pool.size + rollData.pool.bonus - 1;
    rollData.dn = rollData.difficulty.target + rollData.difficulty.penalty;
    if (poolSize > 0) {
        _rollDice(rollData, `${poolSize}d6`, false);
    }
    _rollDice(rollData, `${wrathSize}d6`, true);
}
function _rollDice(rollData, formula, isWrath) {
    let r = new Roll(formula, {});
    r.evaluate();
    r.terms.forEach((term) => {
        if (typeof term === 'object' && term !== null) {
            term.results.forEach(result => {
                let die;
                if (isWrath) {
                    die = _computeWrath(result.result);
                }
                else {
                    die = _computeDice(result.result);
                }
                rollData.result.dice.push(die);
            });
        }
    });
    rollData.rolls.hit.push(r);
}
function _rollDamage(rollData) {
    let ed = rollData.weapon.ed.base + rollData.weapon.ed.bonus;
    let formula = `${ed}d6`;
    let r = new Roll(formula, {});
    r.evaluate();
    rollData.result.damage = {
        dice: [],
        total: rollData.weapon.damage.base + rollData.weapon.damage.bonus
    };
    r.terms.forEach((term) => {
        if (typeof term === 'object' && term !== null) {
            term.results.forEach(result => {
                let die = _computeExtraDice(result.result, rollData.weapon.ed.die);
                rollData.result.damage.total += die.value;
                rollData.result.damage.dice.push(die);
            });
        }
    });
    rollData.rolls.damage.push(r);
}
function _computeChat(rollData) {
    rollData.result.dice.sort((a, b) => { return b.weight - a.weight; });
    rollData.result.success = _countSuccess(rollData);
    rollData.result.failure = _countFailure(rollData);
    rollData.result.shifting = _countShifting(rollData);
    rollData.result.isSuccess = rollData.result.success >= rollData.dn;
    rollData.result.isWrathCritical = _hasWrathValue(rollData, 6);
    rollData.result.isWrathComplication = _hasWrathValue(rollData, 1);
}
function _computeDamageChat(rollData) {
    rollData.result.damage.dice.sort((a, b) => { return b.weight - a.weight; });
    if (rollData.weapon.ap) {
        rollData.weapon.ap.total = rollData.weapon.ap.base + rollData.weapon.ap.bonus;
    }
}
function _computeDice(dieValue) {
    if (dieValue === 6) {
        return {
            name: "icon",
            value: 2,
            score: dieValue,
            isWrath: false,
            rerollable: false,
            weight: 3
        };
    }
    else if (dieValue > 3) {
        return {
            name: "success",
            value: 1,
            score: dieValue,
            isWrath: false,
            rerollable: false,
            weight: 2
        };
    }
    else {
        return {
            name: "failed",
            value: 0,
            score: dieValue,
            isWrath: false,
            rerollable: true,
            weight: 1
        };
    }
}
function _computeExtraDice(dieValue, die) {
    let propertyName = Object.keys(die)[dieValue - 1];
    let value = die[propertyName];
    let name = "failed";
    let weight = 1;
    if (value >= 2) {
        name = "icon";
        weight = 3;
    }
    else if (value === 1) {
        name = "success";
        weight = 2;
    }
    return {
        name: name,
        value: value,
        score: dieValue,
        isWrath: false,
        rerollable: false,
        weight: weight
    };
}
function _computeWrath(dieValue) {
    if (dieValue === 6) {
        return {
            name: "wrath-critical",
            value: 2,
            score: dieValue,
            isWrath: true,
            rerollable: false,
            weight: 0
        };
    }
    else if (dieValue > 3) {
        return {
            name: "wrath-success",
            value: 1,
            score: dieValue,
            isWrath: true,
            rerollable: false,
            weight: -1
        };
    }
    else if (dieValue === 1) {
        return {
            name: "wrath-complication",
            value: 0,
            score: dieValue,
            isWrath: true,
            rerollable: false,
            weight: -3
        };
    }
    else {
        return {
            name: "wrath-failed",
            value: 0,
            score: dieValue,
            isWrath: true,
            rerollable: true,
            weight: -2
        };
    }
}
function _countSuccess(rollData) {
    let success = 0;
    for (let i = 0; i < rollData.result.dice.length; i++) {
        success += rollData.result.dice[i].value;
    }
    return success;
}
function _countFailure(rollData) {
    let failure = 0;
    for (let i = 0; i < rollData.result.dice.length; i++) {
        if (rollData.result.dice[i].value === 0) {
            failure++;
        }
    }
    return failure;
}
function _countShifting(rollData) {
    let shifting = 0;
    let margin = rollData.result.success - rollData.dn;
    for (let i = 0; i < rollData.result.dice.length; i++) {
        if (rollData.result.dice[i].value === 2 && margin - 2 >= 0) {
            shifting++;
            margin = margin - 2;
        }
    }
    return shifting;
}
function _hasWrathValue(rollData, dieValue) {
    for (let i = 0; i < rollData.result.dice.length; i++) {
        let die = rollData.result.dice[i];
        if (die.isWrath && die.score === dieValue) {
            return true;
        }
    }
    return false;
}
function _hasDamage(rollData) {
    let damage = rollData.weapon.damage.base + rollData.weapon.damage.bonus;
    let ed = rollData.weapon.ed.base + rollData.weapon.ed.bonus;
    return (damage > 0 || ed > 0);
}
async function _sendToChat(rollData) {
    const html = await renderTemplate("systems/wrath-and-glory/template/chat/roll.html", rollData);
    let chatData = {
        user: game.user.id,
        rollMode: game.settings.get("core", "rollMode"),
        content: html
    };
    if (["gmroll", "blindroll"].includes(chatData.rollMode)) {
        chatData.whisper = ChatMessage.getWhisperRecipients("GM");
    }
    else if (chatData.rollMode === "selfroll") {
        chatData.whisper = [game.user];
    }
    ChatMessage.create(chatData);
}
async function _sendDamageToChat(rollData) {
    const html = await renderTemplate("systems/wrath-and-glory/template/chat/damage.html", rollData);
    let chatData = {
        user: game.user.id,
        rollMode: game.settings.get("core", "rollMode"),
        content: html
    };
    if (["gmroll", "blindroll"].includes(chatData.rollMode)) {
        chatData.whisper = ChatMessage.getWhisperRecipients("GM");
    }
    else if (chatData.rollMode === "selfroll") {
        chatData.whisper = [game.user];
    }
    ChatMessage.create(chatData);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm9sbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21tb24vcm9sbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFTyxLQUFLLFVBQVUsVUFBVSxDQUFDLFFBQWtCO0lBQ2pELGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUN4QixZQUFZLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDdkIsTUFBTSxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDOUIsQ0FBQztBQUpELGdDQUlDO0FBRU0sS0FBSyxVQUFVLFVBQVUsQ0FBQyxRQUFrQjtJQUNqRCxJQUFJLFVBQVUsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDO0lBQy9CLFFBQVEsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3ZELE1BQU0sVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQzNCLFFBQVEsQ0FBQyxJQUFJLEdBQUcsVUFBVSxDQUFDO0lBQzNCLElBQUksUUFBUSxDQUFDLE1BQU0sQ0FBQyxTQUFTLEVBQUU7UUFDN0IsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3RCLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzdCLE1BQU0saUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUM7S0FDbkM7QUFDSCxDQUFDO0FBVkQsZ0NBVUM7QUFFTSxLQUFLLFVBQVUsV0FBVyxDQUFDLFFBQWtCO0lBQ2xELElBQUksV0FBVyxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUM7SUFDaEMsUUFBUSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDdkQsTUFBTSxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDM0IsUUFBUSxDQUFDLElBQUksR0FBRyxXQUFXLENBQUM7SUFDNUIsSUFBSSxRQUFRLENB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UUFBUSxHQUFhO1FBQ3ZCLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDbEIsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxVQUFVLENBQUM7UUFDL0MsT0FBTyxFQUFFLElBQUk7S0FDZCxDQUFDO0lBQ0YsSUFBSSxDQUFDLFFBQVEsRUFBRSxXQUFXLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxFQUFFO1FBQ3ZELFFBQVEsQ0FBQyxPQUFPLEdBQUcsV0FBVyxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxDQUFDO0tBQzNEO1NBQU0sSUFBSSxRQUFRLENBQUMsUUFBUSxLQUFLLFVBQVUsRUFBRTtRQUMzQyxRQUFRLENBQUMsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0tBQ2hDO0lBQ0QsV0FBVyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMvQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtDaGF0RGF0YSwgRGllLCBEaWVPcHRpb25zLCBSb2xsRGF0YX0gZnJvbSBcIi4uL3R5cGVzXCI7XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjb21tb25Sb2xsKHJvbGxEYXRhOiBSb2xsRGF0YSkge1xuICBfcm9sbFBvb2xEaWNlKHJvbGxEYXRhKTtcbiAgX2NvbXB1dGVDaGF0KHJvbGxEYXRhKTtcbiAgYXdhaXQgX3NlbmRUb0NoYXQocm9sbERhdGEpO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gd2VhcG9uUm9sbChyb2xsRGF0YTogUm9sbERhdGEpIHtcbiAgbGV0IHdlYXBvbk5hbWUgPSByb2xsRGF0YS5uYW1lO1xuICByb2xsRGF0YS5uYW1lID0gZ2FtZS5pMThuLmxvY2FsaXplKHJvbGxEYXRhLnNraWxsTmFtZSk7XG4gIGF3YWl0IGNvbW1vblJvbGwocm9sbERhdGEpO1xuICByb2xsRGF0YS5uYW1lID0gd2VhcG9uTmFtZTtcbiAgaWYgKHJvbGxEYXRhLnJlc3VsdC5pc1N1Y2Nlc3MpIHtcbiAgICBfcm9sbERhbWFnZShyb2xsRGF0YSk7XG4gICAgX2NvbXB1dGVEYW1hZ2VDaGF0KHJvbGxEYXRhKTtcbiAgICBhd2FpdCBfc2VuZERhbWFnZVRvQ2hhdChyb2xsRGF0YSk7XG4gIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHBzeWNoaWNSb2xsKHJvbGxEYXRhOiBSb2xsRGF0YSkge1xuICBsZXQgcHN5Y2hpY05hbWUgPSByb2xsRGF0YS5uYW1lO1xuICByb2xsRGF0YS5uYW1lID0gZ2FtZS5pMThuLmxvY2FsaXplKHJvbGxEYXRhLnNraWxsTmFtZSk7XG4gIGF3YWl0IGNvbW1vblJvbGwocm9sbERhdGEpO1xuICByb2xsRGF0YS5uYW1lID0gcHN5Y2hpY05hbWU7XG4gIGlmIChyb2xsRGF0YS5yZXN1bHQuaXNTdWNjZXNzICYmIF9oYXNEYW1hZ2Uocm9sbERhdGEpKSB7XG4gICAgX3JvbGxEYW1hZ2Uocm9sbERhdGEpO1xuICAgIF9jb21wdXRlRGFtYWdlQ2hhdChyb2xsRGF0YSk7XG4gICAgYXdhaXQgX3NlbmREYW1hZ2VUb0NoYXQocm9sbERhdGEpO1xuICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkYW1hZ2VSb2xsKHJvbGxEYXRhOiBSb2xsRGF0YSkge1xuICBfcm9sbERhbWFnZShyb2xsRGF0YSk7XG4gIF9jb21wdXRlRGFtYWdlQ2hhdChyb2xsRGF0YSk7XG4gIGF3YWl0IF9zZW5kRGFtYWdlVG9DaGF0KHJvbGxEYXRhKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlcm9sbChyb2xsRGF0YTogUm9sbERhdGEpIHtcbiAgcm9sbERhdGEucm9sbHMuaGl0ID0gW107XG4gIHJvbGxEYXRhLnJlc3VsdC5kaWNlID0gcm9sbERhdGEucmVzdWx0LmRpY2UubWFwKGRpZSA9PiB7XG4gICAgaWYgKGRpZS5yZXJvbGxhYmxlKSB7XG4gICAgICBsZXQgciA9IG5ldyBSb2xsKFwiMWQ2XCIsIHt9KS5ldmFsdWF0ZSgpO1xuICAgICAgcm9sbERhdGEucm9sbHMuaGl0LnB1c2gocik7XG4gICAgICBpZiAoZGllLmlzV3JhdGgpIHtcbiAgICAgICAgcmV0dXJuIF9jb21wdXRlV3JhdGgoci50b3RhbCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gX2NvbXB1dGVEaWNlKHIudG90YWwpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZGllO1xuICAgIH1cbiAgfSk7XG4gIF9jb21wdXRlQ2hhdChyb2xsRGF0YSk7XG4gIGF3YWl0IF9zZW5kVG9DaGF0KHJvbGxEYXRhKTtcbn1cblxuZnVuY3Rpb24gX3JvbGxQb29sRGljZShyb2xsRGF0YTogUm9sbERhdGEpIHtcbiAgbGV0IHdyYXRoU2l6ZSA9IHJvbGxEYXRhLndyYXRoLmJhc2UgPiAwID8gcm9sbERhdGEud3JhdGguYmFzZSA6IDE7XG4gIGxldCBwb29sU2l6ZSA9IHJvbGxEYXRhLnBvb2wuc2l6ZSArIHJvbGxEYXRhLnBvb2wuYm9udXMgLSAxO1xuICByb2xsRGF0YS5kbiA9IHJvbGxEYXRhLmRpZmZpY3VsdHkudGFyZ2V0ICsgcm9sbERhdGEuZGlmZmljdWx0eS5wZW5hbHR5O1xuICBpZiAocG9vbFNpemUgPiAwKSB7XG4gICAgX3JvbGxEaWNlKHJvbGxEYXRhLCBgJHtwb29sU2l6ZX1kNmAsIGZhbHNlKTtcbiAgfVxuICBfcm9sbERpY2Uocm9sbERhdGEsIGAke3dyYXRoU2l6ZX1kNmAsIHRydWUpO1xufVxuXG5mdW5jdGlvbiBfcm9sbERpY2Uocm9sbERhdGE6IFJvbGxEYXRhLCBmb3JtdWxhOiBzdHJpbmcsIGlzV3JhdGg6IGJvb2xlYW4pIHtcbiAgbGV0IHIgPSBuZXcgUm9sbChmb3JtdWxhLCB7fSk7XG4gIHIuZXZhbHVhdGUoKTtcbiAgci50ZXJtcy5mb3JFYWNoKCh0ZXJtKSA9PiB7XG4gICAgaWYgKHR5cGVvZiB0ZXJtID09PSAnb2JqZWN0JyAmJiB0ZXJtICE9PSBudWxsKSB7XG4gICAgICB0ZXJtLnJlc3VsdHMuZm9yRWFjaChyZXN1bHQgPT4ge1xuICAgICAgICBsZXQgZGllOiBEaWU7XG4gICAgICAgIGlmIChpc1dyYXRoKSB7XG4gICAgICAgICAgZGllID0gX2NvbXB1dGVXcmF0aChyZXN1bHQucmVzdWx0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBkaWUgPSBfY29tcHV0ZURpY2UocmVzdWx0LnJlc3VsdCk7XG4gICAgICAgIH1cbiAgICAgICAgcm9sbERhdGEucmVzdWx0LmRpY2UucHVzaChkaWUgYXMgRGllKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG4gIHJvbGxEYXRhLnJvbGxzLmhpdC5wdXNoKHIpO1xufVxuXG5mdW5jdGlvbiBfcm9sbERhbWFnZShyb2xsRGF0YTogUm9sbERhdGEpIHtcbiAgbGV0IGVkID0gcm9sbERhdGEud2VhcG9uLmVkLmJhc2UgKyByb2xsRGF0YS53ZWFwb24uZWQuYm9udXM7XG4gIGxldCBmb3JtdWxhID0gYCR7ZWR9ZDZgO1xuICBsZXQgciA9IG5ldyBSb2xsKGZvcm11bGEsIHt9KTtcbiAgci5ldmFsdWF0ZSgpO1xuICByb2xsRGF0YS5yZXN1bHQuZGFtYWdlID0ge1xuICAgIGRpY2U6IFtdLFxuICAgIHRvdGFsOiByb2xsRGF0YS53ZWFwb24uZGFtYWdlLmJhc2UgKyByb2xsRGF0YS53ZWFwb24uZGFtYWdlLmJvbnVzXG4gIH07XG4gIHIudGVybXMuZm9yRWFjaCgodGVybSkgPT4ge1xuICAgIGlmICh0eXBlb2YgdGVybSA9PT0gJ29iamVjdCcgJiYgdGVybSAhPT0gbnVsbCkge1xuICAgICAgdGVybS5yZXN1bHRzLmZvckVhY2gocmVzdWx0ID0+IHtcbiAgICAgICAgbGV0IGRpZSA9IF9jb21wdXRlRXh0cmFEaWNlKHJlc3VsdC5yZXN1bHQsIHJvbGxEYXRhLndlYXBvbi5lZC5kaWUpO1xuICAgICAgICByb2xsRGF0YS5yZXN1bHQuZGFtYWdlLnRvdGFsICs9IGRpZS52YWx1ZTtcbiAgICAgICAgcm9sbERhdGEucmVzdWx0LmRhbWFnZS5kaWNlLnB1c2goZGllKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG4gIHJvbGxEYXRhLnJvbGxzLmRhbWFnZS5wdXNoKHIpO1xufVxuXG5mdW5jdGlvbiBfY29tcHV0ZUNoYXQocm9sbERhdGE6IFJvbGxEYXRhKSB7XG4gIHJvbGxEYXRhLnJlc3VsdC5kaWNlLnNvcnQoKGEsIGIpID0+IHsgcmV0dXJuIGIud2VpZ2h0IC0gYS53ZWlnaHQgfSk7XG4gIHJvbGxEYXRhLnJlc3VsdC5zdWNjZXNzID0gX2NvdW50U3VjY2Vzcyhyb2xsRGF0YSk7XG4gIHJvbGxEYXRhLnJlc3VsdC5mYWlsdXJlID0gX2NvdW50RmFpbHVyZShyb2xsRGF0YSk7XG4gIHJvbGxEYXRhLnJlc3VsdC5zaGlmdGluZyA9IF9jb3VudFNoaWZ0aW5nKHJvbGxEYXRhKTtcbiAgcm9sbERhdGEucmVzdWx0LmlzU3VjY2VzcyA9IHJvbGxEYXRhLnJlc3VsdC5zdWNjZXNzID49IHJvbGxEYXRhLmRuO1xuICByb2xsRGF0YS5yZXN1bHQuaXNXcmF0aENyaXRpY2FsID0gX2hhc1dyYXRoVmFsdWUocm9sbERhdGEsIDYpO1xuICByb2xsRGF0YS5yZXN1bHQuaXNXcmF0aENvbXBsaWNhdGlvbiA9IF9oYXNXcmF0aFZhbHVlKHJvbGxEYXRhLCAxKTtcbn1cblxuZnVuY3Rpb24gX2NvbXB1dGVEYW1hZ2VDaGF0KHJvbGxEYXRhOiBSb2xsRGF0YSkge1xuICByb2xsRGF0YS5yZXN1bHQuZGFtYWdlLmRpY2Uuc29ydCgoYSwgYikgPT4geyByZXR1cm4gYi53ZWlnaHQgLSBhLndlaWdodCB9KTtcbiAgaWYgKHJvbGxEYXRhLndlYXBvbi5hcCkge1xuICAgIHJvbGxEYXRhLndlYXBvbi5hcC50b3RhbCA9IHJvbGxEYXRhLndlYXBvbi5hcC5iYXNlICsgcm9sbERhdGEud2VhcG9uLmFwLmJvbnVzO1xuICB9XG59XG5cbmZ1bmN0aW9uIF9jb21wdXRlRGljZShkaWVWYWx1ZTogbnVtYmVyKSB7XG4gIGlmIChkaWVWYWx1ZSA9PT0gNikge1xuICAgIHJldHVybiB7XG4gICAgICBuYW1lOiBcImljb25cIixcbiAgICAgIHZhbHVlOiAyLFxuICAgICAgc2NvcmU6IGRpZVZhbHVlLFxuICAgICAgaXNXcmF0aDogZmFsc2UsXG4gICAgICByZXJvbGxhYmxlOiBmYWxzZSxcbiAgICAgIHdlaWdodDogM1xuICAgIH07XG4gIH0gZWxzZSBpZiAoZGllVmFsdWUgPiAzKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWU6IFwic3VjY2Vzc1wiLFxuICAgICAgdmFsdWU6IDEsXG4gICAgICBzY29yZTogZGllVmFsdWUsXG4gICAgICBpc1dyYXRoOiBmYWxzZSxcbiAgICAgIHJlcm9sbGFibGU6IGZhbHNlLFxuICAgICAgd2VpZ2h0OiAyXG4gICAgfTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4ge1xuICAgICAgbmFtZTogXCJmYWlsZWRcIixcbiAgICAgIHZhbHVlOiAwLFxuICAgICAgc2NvcmU6IGRpZVZhbHVlLFxuICAgICAgaXNXcmF0aDogZmFsc2UsXG4gICAgICByZXJvbGxhYmxlOiB0cnVlLFxuICAgICAgd2VpZ2h0OiAxXG4gICAgfTtcbiAgfVxufVxuXG5mdW5jdGlvbiBfY29tcHV0ZUV4dHJhRGljZShkaWVWYWx1ZTogbnVtYmVyLCBkaWU6IERpZU9wdGlvbnMpIHtcbiAgbGV0IHByb3BlcnR5TmFtZSA9IE9iamVjdC5rZXlzKGRpZSlbZGllVmFsdWUgLSAxXTtcbiAgbGV0IHZhbHVlID0gZGllW3Byb3BlcnR5TmFtZV07XG4gIGxldCBuYW1lID0gXCJmYWlsZWRcIjtcbiAgbGV0IHdlaWdodCA9IDE7XG4gIGlmICh2YWx1ZSA+PSAyKSB7XG4gICAgbmFtZSA9IFwiaWNvblwiO1xuICAgIHdlaWdodCA9IDM7XG4gIH0gZWxzZSBpZiAodmFsdWUgPT09IDEpIHtcbiAgICBuYW1lID0gXCJzdWNjZXNzXCI7XG4gICAgd2VpZ2h0ID0gMjtcbiAgfVxuICByZXR1cm4ge1xuICAgIG5hbWU6IG5hbWUsXG4gICAgdmFsdWU6IHZhbHVlLFxuICAgIHNjb3JlOiBkaWVWYWx1ZSxcbiAgICBpc1dyYXRoOiBmYWxzZSxcbiAgICByZXJvbGxhYmxlOiBmYWxzZSxcbiAgICB3ZWlnaHQ6IHdlaWdodFxuICB9O1xufVxuXG5mdW5jdGlvbiBfY29tcHV0ZVdyYXRoKGRpZVZhbHVlOiBudW1iZXIpOiBEaWUge1xuICBpZiAoZGllVmFsdWUgPT09IDYpIHtcbiAgICByZXR1cm4ge1xuICAgICAgbmFtZTogXCJ3cmF0aC1jcml0aWNhbFwiLFxuICAgICAgdmFsdWU6IDIsXG4gICAgICBzY29yZTogZGllVmFsdWUsXG4gICAgICBpc1dyYXRoOiB0cnVlLFxuICAgICAgcmVyb2xsYWJsZTogZmFsc2UsXG4gICAgICB3ZWlnaHQ6IDBcbiAgICB9O1xuICB9IGVsc2UgaWYgKGRpZVZhbHVlID4gMykge1xuICAgIHJldHVybiB7XG4gICAgICBuYW1lOiBcIndyYXRoLXN1Y2Nlc3NcIixcbiAgICAgIHZhbHVlOiAxLFxuICAgICAgc2NvcmU6IGRpZVZhbHVlLFxuICAgICAgaXNXcmF0aDogdHJ1ZSxcbiAgICAgIHJlcm9sbGFibGU6IGZhbHNlLFxuICAgICAgd2VpZ2h0OiAtMVxuICAgIH07XG4gIH0gZWxzZSBpZiAoZGllVmFsdWUgPT09IDEpIHtcbiAgICByZXR1cm4ge1xuICAgICAgbmFtZTogXCJ3cmF0aC1jb21wbGljYXRpb25cIixcbiAgICAgIHZhbHVlOiAwLFxuICAgICAgc2NvcmU6IGRpZVZhbHVlLFxuICAgICAgaXNXcmF0aDogdHJ1ZSxcbiAgICAgIHJlcm9sbGFibGU6IGZhbHNlLFxuICAgICAgd2VpZ2h0OiAtM1xuICAgIH07XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWU6IFwid3JhdGgtZmFpbGVkXCIsXG4gICAgICB2YWx1ZTogMCxcbiAgICAgIHNjb3JlOiBkaWVWYWx1ZSxcbiAgICAgIGlzV3JhdGg6IHRydWUsXG4gICAgICByZXJvbGxhYmxlOiB0cnVlLFxuICAgICAgd2VpZ2h0OiAtMlxuICAgIH07XG4gIH1cbn1cblxuZnVuY3Rpb24gX2NvdW50U3VjY2Vzcyhyb2xsRGF0YTogUm9sbERhdGEpIHtcbiAgbGV0IHN1Y2Nlc3MgPSAwO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHJvbGxEYXRhLnJlc3VsdC5kaWNlLmxlbmd0aDsgaSsrKSB7XG4gICAgc3VjY2VzcyArPSByb2xsRGF0YS5yZXN1bHQuZGljZVtpXS52YWx1ZTtcbiAgfVxuICByZXR1cm4gc3VjY2Vzcztcbn1cblxuZnVuY3Rpb24gX2NvdW50RmFpbHVyZShyb2xsRGF0YTogUm9sbERhdGEpIHtcbiAgbGV0IGZhaWx1cmUgPSAwO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHJvbGxEYXRhLnJlc3VsdC5kaWNlLmxlbmd0aDsgaSsrKSB7XG4gICAgaWYgKHJvbGxEYXRhLnJlc3VsdC5kaWNlW2ldLnZhbHVlID09PSAwKSB7XG4gICAgICBmYWlsdXJlKys7XG4gICAgfVxuICB9XG4gIHJldHVybiBmYWlsdXJlO1xufVxuXG5mdW5jdGlvbiBfY291bnRTaGlmdGluZyhyb2xsRGF0YTogUm9sbERhdGEpIHtcbiAgbGV0IHNoaWZ0aW5nID0gMDtcbiAgbGV0IG1hcmdpbiA9IHJvbGxEYXRhLnJlc3VsdC5zdWNjZXNzIC0gcm9sbERhdGEuZG47XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgcm9sbERhdGEucmVzdWx0LmRpY2UubGVuZ3RoOyBpKyspIHtcbiAgICBpZiAocm9sbERhdGEucmVzdWx0LmRpY2VbaV0udmFsdWUgPT09IDIgJiYgbWFyZ2luIC0gMiA+PSAwKSB7XG4gICAgICBzaGlmdGluZysrO1xuICAgICAgbWFyZ2luID0gbWFyZ2luIC0gMjtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHNoaWZ0aW5nO1xufVxuXG5mdW5jdGlvbiBfaGFzV3JhdGhWYWx1ZShyb2xsRGF0YTogUm9sbERhdGEsIGRpZVZhbHVlOiBudW1iZXIpIHtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCByb2xsRGF0YS5yZXN1bHQuZGljZS5sZW5ndGg7IGkrKykge1xuICAgIGxldCBkaWUgPSByb2xsRGF0YS5yZXN1bHQuZGljZVtpXTtcbiAgICBpZiAoZGllLmlzV3JhdGggJiYgZGllLnNjb3JlID09PSBkaWVWYWx1ZSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9XG4gIHJldHVybiBmYWxzZTtcbn1cblxuZnVuY3Rpb24gX2hhc0RhbWFnZShyb2xsRGF0YTogUm9sbERhdGEpIHtcbiAgbGV0IGRhbWFnZSA9IHJvbGxEYXRhLndlYXBvbi5kYW1hZ2UuYmFzZSArIHJvbGxEYXRhLndlYXBvbi5kYW1hZ2UuYm9udXM7XG4gIGxldCBlZCA9IHJvbGxEYXRhLndlYXBvbi5lZC5iYXNlICsgcm9sbERhdGEud2VhcG9uLmVkLmJvbnVzO1xuICByZXR1cm4gKGRhbWFnZSA+IDAgfHwgZWQgPiAwKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gX3NlbmRUb0NoYXQocm9sbERhdGE6Um9sbERhdGEpIHtcbiAgY29uc3QgaHRtbCA9IGF3YWl0IHJlbmRlclRlbXBsYXRlKFwic3lzdGVtcy93cmF0aC1hbmQtZ2xvcnkvdGVtcGxhdGUvY2hhdC9yb2xsLmh0bWxcIiwgcm9sbERhdGEpO1xuICBsZXQgY2hhdERhdGE6IENoYXREYXRhID0ge1xuICAgIHVzZXI6IGdhbWUudXNlci5pZCxcbiAgICByb2xsTW9kZTogZ2FtZS5zZXR0aW5ncy5nZXQoXCJjb3JlXCIsIFwicm9sbE1vZGVcIiksXG4gICAgY29udGVudDogaHRtbFxuICB9O1xuICBpZiAoW1wiZ21yb2xsXCIsIFwiYmxpbmRyb2xsXCJdLmluY2x1ZGVzKGNoYXREYXRhLnJvbGxNb2RlKSkge1xuICAgIGNoYXREYXRhLndoaXNwZXIgPSBDaGF0TWVzc2FnZS5nZXRXaGlzcGVyUmVjaXBpZW50cyhcIkdNXCIpO1xuICB9IGVsc2UgaWYgKGNoYXREYXRhLnJvbGxNb2RlID09PSBcInNlbGZyb2xsXCIpIHtcbiAgICBjaGF0RGF0YS53aGlzcGVyID0gW2dhbWUudXNlcl07XG4gIH1cbiAgQ2hhdE1lc3NhZ2UuY3JlYXRlKGNoYXREYXRhKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gX3NlbmREYW1hZ2VUb0NoYXQocm9sbERhdGE6IFJvbGxEYXRhKSB7XG4gIGNvbnN0IGh0bWwgPSBhd2FpdCByZW5kZXJUZW1wbGF0ZShcInN5c3RlbXMvd3JhdGgtYW5kLWdsb3J5L3RlbXBsYXRlL2NoYXQvZGFtYWdlLmh0bWxcIiwgcm9sbERhdGEpO1xuICBsZXQgY2hhdERhdGE6IENoYXREYXRhID0ge1xuICAgIHVzZXI6IGdhbWUudXNlci5pZCxcbiAgICByb2xsTW9kZTogZ2FtZS5zZXR0aW5ncy5nZXQoXCJjb3JlXCIsIFwicm9sbE1vZGVcIiksXG4gICAgY29udGVudDogaHRtbFxuICB9O1xuICBpZiAoW1wiZ21yb2xsXCIsIFwiYmxpbmRyb2xsXCJdLmluY2x1ZGVzKGNoYXREYXRhLnJvbGxNb2RlKSkge1xuICAgIGNoYXREYXRhLndoaXNwZXIgPSBDaGF0TWVzc2FnZS5nZXRXaGlzcGVyUmVjaXBpZW50cyhcIkdNXCIpO1xuICB9IGVsc2UgaWYgKGNoYXREYXRhLnJvbGxNb2RlID09PSBcInNlbGZyb2xsXCIpIHtcbiAgICBjaGF0RGF0YS53aGlzcGVyID0gW2dhbWUudXNlcl07XG4gIH1cbiAgQ2hhdE1lc3NhZ2UuY3JlYXRlKGNoYXREYXRhKTtcbn0iXX0=