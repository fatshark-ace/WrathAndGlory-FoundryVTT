"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.WrathAndGloryActor = void 0;
class WrathAndGloryActor extends Actor {
    async _preCreate(data, options, user) {
        let initData = {
            "token.bar1": { "attribute": "combat.wounds" },
            "token.bar2": { "attribute": "combat.shock" },
            "token.displayName": CONST.TOKEN_DISPLAY_MODES.OWNER_HOVER,
            "token.displayBars": CONST.TOKEN_DISPLAY_MODES.OWNER_HOVER,
            "token.disposition": CONST.TOKEN_DISPOSITIONS.NEUTRAL,
            "token.name": data.name
        };
        if (data.type === "agent") {
            initData["token.vision"] = true;
            initData["token.actorLink"] = true;
        }
        this.data.update(initData);
    }
    prepareData() {
        super.prepareData();
        if (this.type === "agent") {
            this._initializeAgent();
        }
        else if (this.type === "threat") {
            this._initializeThreat();
        }
    }
    _initializeAgent() {
        this._initializeBonus();
        this._computeItems();
        this._computeAttributes();
        this._computeSkills();
        this._computeCombat();
        this._computeExperience();
    }
    _initializeThreat() {
        this._initializeBonus();
        this._computeItems();
        this._computeAttributes();
        this._computeSkills();
    }
    _initializeBonus() {
        if (this.advances) {
            this.advances.experience.spent = 0;
            this.advances.experience.total = 0;
        }
        for (let attribute of Object.values(this.attributes)) {
            attribute.bonus = 0;
        }
        for (let skill of Object.values(this.skills)) {
            skill.bonus = 0;
        }
    }
    _computeItems() {
        this.combat.resilence.armor = 0;
        for (let item of this.items) {
            if (item.isArmour) {
                this._computeArmour(item);
            }
            if (item.bonus) {
                this._computeBonus(item);
            }
            if (this.advances && item.cost) {
                this.advances.experience.spent = this.advances.experience.spent + item.cost;
            }
        }
    }
    _computeArmour(item) {
        if (this.combat.resilence.armor < item.rating) {
            this.combat.resilence.armor = item.rating;
        }
    }
    _computeAttributes() {
        for (let attribute of Object.values(this.attributes)) {
            attribute.total = attribute.rating + attribute.bonus;
            if (this.advances) {
                this.advances.experience.spent = this.advances.experience.spent + attribute.cost;
            }
        }
    }
    _computeBonus(item) {
        let bonus = item.bonus;
        for (let [key, value] of Object.entries(this.attributes)) {
            value.bonus = value.bonus + bonus.attributes[key];
        }
        for (let [key, value] of Object.entries(this.skills)) {
            value.bonus = value.bonus + bonus.skills[key];
        }
        for (let [key, value] of Object.entries(this.combat)) {
            if (value.hasOwnProperty("bonus")) {
                value.bonus = value.bonus + bonus.combat[key];
            }
        }
    }
    _computeSkills() {
        let middle = Object.values(this.skills).length / 2;
        let i = 0;
        for (const skill of Object.values(this.skills)) {
            skill.total = this.attributes[skill.attribute].total + skill.rating + skill.bonus;
            if (this.advances) {
                this.advances.experience.spent = this.advances.experience.spent + skill.cost;
            }
            skill.isLeft = i < middle;
            skill.isRight = i >= middle;
            i++;
        }
    }
    _computeCombat() {
        this.combat.passiveAwareness.total = this._setDefault(Math.ceil(this.skills.awareness.total / 2) + this.combat.passiveAwareness.bonus, 1);
        this.combat.defense.total = this._setDefault(this.attributes.initiative.total - 1 + this.combat.defense.bonus, 1);
        this.combat.resolve.total = this._setDefault(this.attributes.willpower.total - 1 + this.combat.resolve.bonus, 1);
        this.corruption.conviction = this._setDefault(this.attributes.willpower.total, 1);
        this.combat.resilence.total = this._setDefault(this.attributes.toughness.rating + 1 + this.combat.resilence.bonus + this.combat.resilence.armor, 1);
        this.combat.wounds.max = this._setDefault((this.advances.tier * 2) + this.attributes.toughness.rating + this.combat.wounds.bonus, 1);
        this.combat.determination.total = this._setDefault(this.attributes.toughness.rating + this.combat.determination.bonus, 1);
        this.combat.shock.max = this._setDefault(this.attributes.willpower.rating + this.advances.tier + this.combat.shock.bonus, 1);
    }
    _setDefault(value, fallback) {
        return (value < fallback ? fallback : value);
    }
    _computeExperience() {
        this.advances.experience.spent = this.advances.experience.spent + this.advances.species;
        this.advances.experience.total = this.advances.experience.current + this.advances.experience.spent;
    }
    get Size() {
        switch (this.combat.size) {
            case "tiny":
                return game.i18n.localize("SIZE.TINY");
            case "small":
                return game.i18n.localize("SIZE.SMALL");
            case "average":
                return game.i18n.localize("SIZE.AVERAGE");
            case "large":
                return game.i18n.localize("SIZE.LARGE");
            case "huge":
                return game.i18n.localize("SIZE.HUGE");
            case "gargantuan":
                return game.i18n.localize("SIZE.GARGANTUAN");
            default:
                return game.i18n.localize("SIZE.AVERAGE");
        }
    }
    get attributes() {
        return this.data.data.attributes;
    }
    get skills() {
        return this.data.data.skills;
    }
    get combat() {
        return this.data.data.combat;
    }
    get bio() {
        return this.data.data.bio;
    }
    get advances() {
        return this.data.data.advances;
    }
    get resources() {
        return this.data.data.resources;
    }
    get corruption() {
        return this.data.data.corruption;
    }
    get notes() {
        return this.data.data.notes;
    }
}
exports.WrathAndGloryActor = WrathAndGloryActor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWN0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29tbW9uL2FjdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUdBLE1BQWEsa0JBQW1CLFNBQVEsS0FBSztJQUV6QyxLQUFLLENBQUMsVUFBVSxDQUFDLElBQVUsRUFBRSxPQUFhLEVBQUUsSUFBVTtRQUNsRCxJQUFJLFFBQVEsR0FBUTtZQUNoQixZQUFZLEVBQUUsRUFBQyxXQUFXLEVBQUUsZUFBZSxFQUFDO1lBQzVDLFlBQVksRUFBRSxFQUFDLFdBQVcsRUFBRSxjQUFjLEVBQUM7WUFDM0MsbUJBQW1CLEVBQUUsS0FBSyxDQUFDLG1CQUFtQixDQUFDLFdBQVc7WUFDMUQsbUJBQW1CLEVBQUUsS0FBSyxDQUFDLG1CQUFtQixDQUFDLFdBQVc7WUFDMUQsbUJBQW1CLEVBQUUsS0FBSyxDQUFDLGtCQUFrQixDQUFDLE9BQU87WUFDckQsWUFBWSxFQUFFLElBQUksQ0FBQyxJQUFJO1NBQzFCLENBQUE7UUFDRCxJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssT0FBTyxFQUFFO1lBQ3ZCLFFBQVEsQ0FBQyxjQUFjLENBQUMsR0FBRyxJQUFJLENBQUM7WUFDaEMsUUFBUSxDQUFDLGlCQUFpQixDQUFDLEdBQUcsSUFBSSxDQUFDO1NBQ3RDO1FBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUE7SUFDOUIsQ0FBQztJQUVELFdBQVc7UUFDUCxLQUFLLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDcEIsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLE9BQU8sRUFBRTtZQUN2QixJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztTQUMzQjthQUFNLElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxRQUFRLEVBQUU7WUFDL0IsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7U0FDNUI7SUFDTCxDQUFDO0lBRUQsZ0JBQWdCO1FBQ1osSUFBSSxDQUFDLGdC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QUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQTtJQUNoQyxDQUFDO0lBRUQsSUFBSSxNQUFNO1FBQ04sT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUE7SUFDaEMsQ0FBQztJQUVELElBQUksR0FBRztRQUNILE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFBO0lBQzdCLENBQUM7SUFFRCxJQUFJLFFBQVE7UUFDUixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQTtJQUNsQyxDQUFDO0lBRUQsSUFBSSxTQUFTO1FBQ1QsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUE7SUFDbkMsQ0FBQztJQUVELElBQUksVUFBVTtRQUNWLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFBO0lBQ3BDLENBQUM7SUFFRCxJQUFJLEtBQUs7UUFDTCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQTtJQUMvQixDQUFDO0NBQ0o7QUExTEQsZ0RBMExDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtBdHRyaWJ1dGUsIENvbWJhdCwgRGF0YSwgU2tpbGx9IGZyb20gXCIuLi90eXBlc1wiO1xuaW1wb3J0IHtXcmF0aEFuZEdsb3J5SXRlbX0gZnJvbSBcIi4vaXRlbVwiO1xuXG5leHBvcnQgY2xhc3MgV3JhdGhBbmRHbG9yeUFjdG9yIGV4dGVuZHMgQWN0b3Ige1xuXG4gICAgYXN5bmMgX3ByZUNyZWF0ZShkYXRhOiBEYXRhLCBvcHRpb25zOiB2b2lkLCB1c2VyOiB2b2lkKSB7XG4gICAgICAgIGxldCBpbml0RGF0YTogYW55ID0ge1xuICAgICAgICAgICAgXCJ0b2tlbi5iYXIxXCI6IHtcImF0dHJpYnV0ZVwiOiBcImNvbWJhdC53b3VuZHNcIn0sXG4gICAgICAgICAgICBcInRva2VuLmJhcjJcIjoge1wiYXR0cmlidXRlXCI6IFwiY29tYmF0LnNob2NrXCJ9LFxuICAgICAgICAgICAgXCJ0b2tlbi5kaXNwbGF5TmFtZVwiOiBDT05TVC5UT0tFTl9ESVNQTEFZX01PREVTLk9XTkVSX0hPVkVSLFxuICAgICAgICAgICAgXCJ0b2tlbi5kaXNwbGF5QmFyc1wiOiBDT05TVC5UT0tFTl9ESVNQTEFZX01PREVTLk9XTkVSX0hPVkVSLFxuICAgICAgICAgICAgXCJ0b2tlbi5kaXNwb3NpdGlvblwiOiBDT05TVC5UT0tFTl9ESVNQT1NJVElPTlMuTkVVVFJBTCxcbiAgICAgICAgICAgIFwidG9rZW4ubmFtZVwiOiBkYXRhLm5hbWVcbiAgICAgICAgfVxuICAgICAgICBpZiAoZGF0YS50eXBlID09PSBcImFnZW50XCIpIHtcbiAgICAgICAgICAgIGluaXREYXRhW1widG9rZW4udmlzaW9uXCJdID0gdHJ1ZTtcbiAgICAgICAgICAgIGluaXREYXRhW1widG9rZW4uYWN0b3JMaW5rXCJdID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmRhdGEudXBkYXRlKGluaXREYXRhKVxuICAgIH1cblxuICAgIHByZXBhcmVEYXRhKCkge1xuICAgICAgICBzdXBlci5wcmVwYXJlRGF0YSgpO1xuICAgICAgICBpZiAodGhpcy50eXBlID09PSBcImFnZW50XCIpIHtcbiAgICAgICAgICAgIHRoaXMuX2luaXRpYWxpemVBZ2VudCgpO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMudHlwZSA9PT0gXCJ0aHJlYXRcIikge1xuICAgICAgICAgICAgdGhpcy5faW5pdGlhbGl6ZVRocmVhdCgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgX2luaXRpYWxpemVBZ2VudCgpIHtcbiAgICAgICAgdGhpcy5faW5pdGlhbGl6ZUJvbnVzKCk7XG4gICAgICAgIHRoaXMuX2NvbXB1dGVJdGVtcygpO1xuICAgICAgICB0aGlzLl9jb21wdXRlQXR0cmlidXRlcygpO1xuICAgICAgICB0aGlzLl9jb21wdXRlU2tpbGxzKCk7XG4gICAgICAgIHRoaXMuX2NvbXB1dGVDb21iYXQoKTtcbiAgICAgICAgdGhpcy5fY29tcHV0ZUV4cGVyaWVuY2UoKTtcbiAgICB9XG5cbiAgICBfaW5pdGlhbGl6ZVRocmVhdCgpIHtcbiAgICAgICAgdGhpcy5faW5pdGlhbGl6ZUJvbnVzKCk7XG4gICAgICAgIHRoaXMuX2NvbXB1dGVJdGVtcygpO1xuICAgICAgICB0aGlzLl9jb21wdXRlQXR0cmlidXRlcygpO1xuICAgICAgICB0aGlzLl9jb21wdXRlU2tpbGxzKCk7XG4gICAgfVxuXG4gICAgX2luaXRpYWxpemVCb251cygpIHtcbiAgICAgICAgaWYgKHRoaXMuYWR2YW5jZXMpIHtcbiAgICAgICAgICAgIHRoaXMuYWR2YW5jZXMuZXhwZXJpZW5jZS5zcGVudCA9IDA7XG4gICAgICAgICAgICB0aGlzLmFkdmFuY2VzLmV4cGVyaWVuY2UudG90YWwgPSAwO1xuICAgICAgICB9XG4gICAgICAgIGZvciAobGV0IGF0dHJpYnV0ZSBvZiBPYmplY3QudmFsdWVzKHRoaXMuYXR0cmlidXRlcykpIHtcbiAgICAgICAgICAgIGF0dHJpYnV0ZS5ib251cyA9IDA7XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChsZXQgc2tpbGwgb2YgT2JqZWN0LnZhbHVlcyh0aGlzLnNraWxscykpIHtcbiAgICAgICAgICAgIHNraWxsLmJvbnVzID0gMDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9jb21wdXRlSXRlbXMoKSB7XG4gICAgICAgIHRoaXMuY29tYmF0LnJlc2lsZW5jZS5hcm1vciA9IDA7XG4gICAgICAgIGZvciAobGV0IGl0ZW0gb2YgdGhpcy5pdGVtcykge1xuXG4gICAgICAgICAgICBpZiAoaXRlbS5pc0FybW91cikge1xuICAgICAgICAgICAgICAgIHRoaXMuX2NvbXB1dGVBcm1vdXIoaXRlbSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoaXRlbS5ib251cykge1xuICAgICAgICAgICAgICAgIHRoaXMuX2NvbXB1dGVCb251cyhpdGVtKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh0aGlzLmFkdmFuY2VzICYmIGl0ZW0uY29zdCkge1xuICAgICAgICAgICAgICAgIHRoaXMuYWR2YW5jZXMuZXhwZXJpZW5jZS5zcGVudCA9IHRoaXMuYWR2YW5jZXMuZXhwZXJpZW5jZS5zcGVudCArIGl0ZW0uY29zdDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9jb21wdXRlQXJtb3VyKGl0ZW06IFdyYXRoQW5kR2xvcnlJdGVtKSB7XG4gICAgICAgIGlmICh0aGlzLmNvbWJhdC5yZXNpbGVuY2UuYXJtb3IgPCBpdGVtLnJhdGluZykge1xuICAgICAgICAgICAgdGhpcy5jb21iYXQucmVzaWxlbmNlLmFybW9yID0gaXRlbS5yYXRpbmc7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBfY29tcHV0ZUF0dHJpYnV0ZXMoKSB7XG4gICAgICAgIGZvciAobGV0IGF0dHJpYnV0ZSBvZiBPYmplY3QudmFsdWVzKHRoaXMuYXR0cmlidXRlcykgYXMgQXJyYXk8QXR0cmlidXRlPikge1xuICAgICAgICAgICAgYXR0cmlidXRlLnRvdGFsID0gYXR0cmlidXRlLnJhdGluZyArIGF0dHJpYnV0ZS5ib251cztcbiAgICAgICAgICAgIGlmICh0aGlzLmFkdmFuY2VzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hZHZhbmNlcy5leHBlcmllbmNlLnNwZW50ID0gdGhpcy5hZHZhbmNlcy5leHBlcmllbmNlLnNwZW50ICsgYXR0cmlidXRlLmNvc3Q7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBfY29tcHV0ZUJvbnVzKGl0ZW06IFdyYXRoQW5kR2xvcnlJdGVtKSB7XG4gICAgICAgIGxldCBib251cyA9IGl0ZW0uYm9udXNcbiAgICAgICAgZm9yIChsZXQgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHRoaXMuYXR0cmlidXRlcykpIHtcbiAgICAgICAgICAgIHZhbHVlLmJvbnVzID0gdmFsdWUuYm9udXMgKyBib251cy5hdHRyaWJ1dGVzW2tleV07XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChsZXQgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHRoaXMuc2tpbGxzKSkge1xuICAgICAgICAgICAgdmFsdWUuYm9udXMgPSB2YWx1ZS5ib251cyArIGJvbnVzLnNraWxsc1trZXldO1xuICAgICAgICB9XG4gICAgICAgIGZvciAobGV0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLmNvbWJhdCkpIHtcbiAgICAgICAgICAgIGlmICh2YWx1ZS5oYXNPd25Qcm9wZXJ0eShcImJvbnVzXCIpKSB7XG4gICAgICAgICAgICAgICAgdmFsdWUuYm9udXMgPSB2YWx1ZS5ib251cyArIGJvbnVzLmNvbWJhdFtrZXldO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgX2NvbXB1dGVTa2lsbHMoKSB7XG4gICAgICAgIGxldCBtaWRkbGUgPSBPYmplY3QudmFsdWVzKHRoaXMuc2tpbGxzKS5sZW5ndGggLyAyO1xuICAgICAgICBsZXQgaSA9IDA7XG4gICAgICAgIGZvciAoY29uc3Qgc2tpbGwgb2YgT2JqZWN0LnZhbHVlcyh0aGlzLnNraWxscykpIHtcbiAgICAgICAgICAgIHNraWxsLnRvdGFsID0gdGhpcy5hdHRyaWJ1dGVzW3NraWxsLmF0dHJpYnV0ZV0udG90YWwgKyBza2lsbC5yYXRpbmcgKyBza2lsbC5ib251cztcbiAgICAgICAgICAgIGlmICh0aGlzLmFkdmFuY2VzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hZHZhbmNlcy5leHBlcmllbmNlLnNwZW50ID0gdGhpcy5hZHZhbmNlcy5leHBlcmllbmNlLnNwZW50ICsgc2tpbGwuY29zdDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHNraWxsLmlzTGVmdCA9IGkgPCBtaWRkbGU7XG4gICAgICAgICAgICBza2lsbC5pc1JpZ2h0ID0gaSA+PSBtaWRkbGU7XG4gICAgICAgICAgICBpKys7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBfY29tcHV0ZUNvbWJhdCgpIHtcbiAgICAgICAgdGhpcy5jb21iYXQucGFzc2l2ZUF3YXJlbmVzcy50b3RhbCA9IHRoaXMuX3NldERlZmF1bHQoTWF0aC5jZWlsKHRoaXMuc2tpbGxzLmF3YXJlbmVzcy50b3RhbCAvIDIpICsgdGhpcy5jb21iYXQucGFzc2l2ZUF3YXJlbmVzcy5ib251cywgMSk7XG4gICAgICAgIHRoaXMuY29tYmF0LmRlZmVuc2UudG90YWwgPSB0aGlzLl9zZXREZWZhdWx0KHRoaXMuYXR0cmlidXRlcy5pbml0aWF0aXZlLnRvdGFsIC0gMSArIHRoaXMuY29tYmF0LmRlZmVuc2UuYm9udXMsIDEpO1xuICAgICAgICB0aGlzLmNvbWJhdC5yZXNvbHZlLnRvdGFsID0gdGhpcy5fc2V0RGVmYXVsdCh0aGlzLmF0dHJpYnV0ZXMud2lsbHBvd2VyLnRvdGFsIC0gMSArIHRoaXMuY29tYmF0LnJlc29sdmUuYm9udXMsIDEpO1xuICAgICAgICB0aGlzLmNvcnJ1cHRpb24uY29udmljdGlvbiA9IHRoaXMuX3NldERlZmF1bHQodGhpcy5hdHRyaWJ1dGVzLndpbGxwb3dlci50b3RhbCwgMSk7XG4gICAgICAgIHRoaXMuY29tYmF0LnJlc2lsZW5jZS50b3RhbCA9IHRoaXMuX3NldERlZmF1bHQodGhpcy5hdHRyaWJ1dGVzLnRvdWdobmVzcy5yYXRpbmcgKyAxICsgdGhpcy5jb21iYXQucmVzaWxlbmNlLmJvbnVzICsgdGhpcy5jb21iYXQucmVzaWxlbmNlLmFybW9yLCAxKTtcbiAgICAgICAgdGhpcy5jb21iYXQud291bmRzLm1heCA9IHRoaXMuX3NldERlZmF1bHQoKHRoaXMuYWR2YW5jZXMudGllciAqIDIpICsgdGhpcy5hdHRyaWJ1dGVzLnRvdWdobmVzcy5yYXRpbmcgKyB0aGlzLmNvbWJhdC53b3VuZHMuYm9udXMsIDEpO1xuICAgICAgICB0aGlzLmNvbWJhdC5kZXRlcm1pbmF0aW9uLnRvdGFsID0gdGhpcy5fc2V0RGVmYXVsdCh0aGlzLmF0dHJpYnV0ZXMudG91Z2huZXNzLnJhdGluZyArIHRoaXMuY29tYmF0LmRldGVybWluYXRpb24uYm9udXMsIDEpO1xuICAgICAgICB0aGlzLmNvbWJhdC5zaG9jay5tYXggPSB0aGlzLl9zZXREZWZhdWx0KHRoaXMuYXR0cmlidXRlcy53aWxscG93ZXIucmF0aW5nICsgdGhpcy5hZHZhbmNlcy50aWVyICsgdGhpcy5jb21iYXQuc2hvY2suYm9udXMsIDEpO1xuICAgIH1cblxuICAgIF9zZXREZWZhdWx0KHZhbHVlOiBudW1iZXIsIGZhbGxiYWNrOiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuICh2YWx1ZSA8IGZhbGxiYWNrID8gZmFsbGJhY2sgOiB2YWx1ZSk7XG4gICAgfVxuXG4gICAgX2NvbXB1dGVFeHBlcmllbmNlKCkge1xuICAgICAgICB0aGlzLmFkdmFuY2VzLmV4cGVyaWVuY2Uuc3BlbnQgPSB0aGlzLmFkdmFuY2VzLmV4cGVyaWVuY2Uuc3BlbnQgKyB0aGlzLmFkdmFuY2VzLnNwZWNpZXM7XG4gICAgICAgIHRoaXMuYWR2YW5jZXMuZXhwZXJpZW5jZS50b3RhbCA9IHRoaXMuYWR2YW5jZXMuZXhwZXJpZW5jZS5jdXJyZW50ICsgdGhpcy5hZHZhbmNlcy5leHBlcmllbmNlLnNwZW50O1xuICAgIH1cblxuICAgIGdldCBTaXplKCkge1xuICAgICAgICBzd2l0Y2ggKHRoaXMuY29tYmF0LnNpemUpIHtcbiAgICAgICAgICAgIGNhc2UgXCJ0aW55XCI6XG4gICAgICAgICAgICAgICAgcmV0dXJuIGdhbWUuaTE4bi5sb2NhbGl6ZShcIlNJWkUuVElOWVwiKTtcbiAgICAgICAgICAgIGNhc2UgXCJzbWFsbFwiOlxuICAgICAgICAgICAgICAgIHJldHVybiBnYW1lLmkxOG4ubG9jYWxpemUoXCJTSVpFLlNNQUxMXCIpO1xuICAgICAgICAgICAgY2FzZSBcImF2ZXJhZ2VcIjpcbiAgICAgICAgICAgICAgICByZXR1cm4gZ2FtZS5pMThuLmxvY2FsaXplKFwiU0laRS5BVkVSQUdFXCIpO1xuICAgICAgICAgICAgY2FzZSBcImxhcmdlXCI6XG4gICAgICAgICAgICAgICAgcmV0dXJuIGdhbWUuaTE4bi5sb2NhbGl6ZShcIlNJWkUuTEFSR0VcIik7XG4gICAgICAgICAgICBjYXNlIFwiaHVnZVwiOlxuICAgICAgICAgICAgICAgIHJldHVybiBnYW1lLmkxOG4ubG9jYWxpemUoXCJTSVpFLkhVR0VcIik7XG4gICAgICAgICAgICBjYXNlIFwiZ2FyZ2FudHVhblwiOlxuICAgICAgICAgICAgICAgIHJldHVybiBnYW1lLmkxOG4ubG9jYWxpemUoXCJTSVpFLkdBUkdBTlRVQU5cIik7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHJldHVybiBnYW1lLmkxOG4ubG9jYWxpemUoXCJTSVpFLkFWRVJBR0VcIik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXQgYXR0cmlidXRlcygpOiBSZWNvcmQ8c3RyaW5nLCBBdHRyaWJ1dGU+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGF0YS5kYXRhLmF0dHJpYnV0ZXNcbiAgICB9XG5cbiAgICBnZXQgc2tpbGxzKCk6IFJlY29yZDxzdHJpbmcsIFNraWxsPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmRhdGEuZGF0YS5za2lsbHNcbiAgICB9XG5cbiAgICBnZXQgY29tYmF0KCk6IENvbWJhdCB7XG4gICAgICAgIHJldHVybiB0aGlzLmRhdGEuZGF0YS5jb21iYXRcbiAgICB9XG5cbiAgICBnZXQgYmlvKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5kYXRhLmRhdGEuYmlvXG4gICAgfVxuXG4gICAgZ2V0IGFkdmFuY2VzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5kYXRhLmRhdGEuYWR2YW5jZXNcbiAgICB9XG5cbiAgICBnZXQgcmVzb3VyY2VzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5kYXRhLmRhdGEucmVzb3VyY2VzXG4gICAgfVxuXG4gICAgZ2V0IGNvcnJ1cHRpb24oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmRhdGEuZGF0YS5jb3JydXB0aW9uXG4gICAgfVxuXG4gICAgZ2V0IG5vdGVzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5kYXRhLmRhdGEubm90ZXNcbiAgICB9XG59Il19