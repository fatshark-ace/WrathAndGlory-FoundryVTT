"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.migrateCompendium = exports.migrateWorld = void 0;
const migrateWorld = async () => {
    const schemaVersion = 1;
    const worldSchemaVersion = Number(game.settings.get("wrath-and-glory", "worldSchemaVersion"));
    if (worldSchemaVersion !== schemaVersion && game.user.isGM) {
        ui.notifications.info("Upgrading the world, please wait...");
        for (let actor of game.actors.contents) {
            try {
                const update = migrateActorData(actor.data, worldSchemaVersion);
                if (!isObjectEmpty(update)) {
                    await actor.update(update, { enforceTypes: false });
                }
            }
            catch (e) {
                console.error(e);
            }
        }
        for (let item of game.items.contents) {
            try {
                const update = migrateItemData(item.data, worldSchemaVersion);
                if (!isObjectEmpty(update)) {
                    await item.update(update, { enforceTypes: false });
                }
            }
            catch (e) {
                console.error(e);
            }
        }
        for (let scene of game.scenes.contents) {
            try {
                const update = migrateSceneData(scene.data, worldSchemaVersion);
                if (!isObjectEmpty(update)) {
                    await scene.update(update, { enforceTypes: false });
                }
            }
            catch (err) {
                console.error(err);
            }
        }
        for (let pack of game.packs.filter((p) => p.metadata.package === "world" && ["Actor"].includes(p.metadata.entity))) {
            await exports.migrateCompendium(pack, worldSchemaVersion);
        }
        game.settings.set("wrath-and-glory", "worldSchemaVersion", schemaVersion);
        ui.notifications.info("Upgrade complete!");
    }
};
exports.migrateWorld = migrateWorld;
const migrateActorData = (actor, worldSchemaVersion) => {
    const update = {};
    if (worldSchemaVersion < 1) {
        if (actor.type === "agent" || actor.type === "threat") {
            update["data.combat.stealth"] = 0;
        }
    }
    let itemsChanged = false;
    const items = actor.items.map((item) => {
        const itemUpdate = migrateItemData(item, worldSchemaVersion);
        if (!isObjectEmpty(itemUpdate)) {
            itemsChanged = true;
            return mergeObject(item, itemUpdate, { enforceTypes: false, inplace: false });
        }
        return item;
    });
    if (itemsChanged) {
        update.items = items;
    }
    return update;
};
const migrateItemData = (item, worldSchemaVersion) => {
    const update = {};
    if (worldSchemaVersion < 1) {
        if (item.type === "weapon") {
            update["data.attack"] = {
                base: 0,
                bonus: 0,
                rank: "none"
            };
            update["data.damage"] = {
                base: item.data.damage,
                bonus: 0,
                rank: "none"
            };
            update["data.ed"] = {
                base: item.data.ed,
                bonus: 0,
                rank: "none",
                die: {
                    one: 0,
                    two: 0,
                    three: 0,
                    four: 1,
                    five: 1,
                    six: 2,
                }
            };
            update["data.ap"] = {
                base: item.data.ap,
                bonus: 0,
                rank: "none"
            };
        }
        else if (item.type === "psychicPower") {
            update["data.damage"] = {
                base: 0,
                bonus: 0,
                rank: "none",
                die: {
                    one: 0,
                    two: 0,
                    three: 0,
                    four: 1,
                    five: 1,
                    six: 2,
                }
            };
            update["data.ed"] = {
                base: 0,
                bonus: 0,
                rank: "none"
            };
        }
    }
    if (!isObjectEmpty(update)) {
        update._id = item._id;
    }
    return update;
};
const migrateSceneData = (scene, worldSchemaVersion) => {
    const tokens = foundry.utils.deepClone(scene.tokens);
    return {
        tokens: tokens.map((tokenData) => {
            if (!tokenData.actorId || tokenData.actorLink || !tokenData.actorData.data) {
                tokenData.actorData = {};
                return tokenData;
            }
            const token = new Token(tokenData);
            if (!token.actor) {
                tokenData.actorId = null;
                tokenData.actorData = {};
            }
            else if (!tokenData.actorLink && token.data.actorData.items) {
                const update = migrateActorData(token.data.actorData, worldSchemaVersion);
                console.log("ACTOR CHANGED", token.data.actorData, update);
                tokenData.actorData = mergeObject(token.data.actorData, update);
            }
            return tokenData;
        }),
    };
};
const migrateCompendium = async function (pack, worldSchemaVersion) {
    const entity = pack.metadata.entity;
    await pack.migrate();
    const content = await pack.getContent();
    for (let ent of content) {
        let updateData = {};
        if (entity === "Actor") {
            updateData = migrateActorData(ent.data, worldSchemaVersion);
        }
        if (!isObjectEmpty(updateData)) {
            expandObject(updateData);
            updateData["_id"] = ent._id;
            await pack.updateEntity(updateData);
        }
    }
};
exports.migrateCompendium = migrateCompendium;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWlncmF0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NvbW1vbi9taWdyYXRpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBR08sTUFBTSxZQUFZLEdBQUcsS0FBSyxJQUFJLEVBQUU7SUFDbkMsTUFBTSxhQUFhLEdBQUcsQ0FBQyxDQUFDO0lBQ3hCLE1BQU0sa0JBQWtCLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGlCQUFpQixFQUFFLG9CQUFvQixDQUFDLENBQUMsQ0FBQztJQUM5RixJQUFJLGtCQUFrQixLQUFLLGFBQWEsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRTtRQUN4RCxFQUFFLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFDO1FBQzdELEtBQUssSUFBSSxLQUFLLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUU7WUFDcEMsSUFBSTtnQkFDQSxNQUFNLE1BQU0sR0FBRyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLGtCQUFrQixDQUFDLENBQUM7Z0JBQ2hFLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLEVBQUU7b0JBQ3hCLE1BQU0sS0FBSyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsRUFBQyxZQUFZLEVBQUUsS0FBSyxFQUFDLENBQUMsQ0FBQztpQkFDckQ7YUFDSjtZQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUNSLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDcEI7U0FDSjtRQUNELEtBQUssSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUU7WUFDbEMsSUFBSTtnQkFDQSxNQUFNLE1BQU0sR0FBRyxlQUFlLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO2dCQUM5RCxJQUFJLENBQUMsYUFBYSxDQUFD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bSBcIi4uL3R5cGVzXCI7XG5pbXBvcnQge1dyYXRoQW5kR2xvcnlJdGVtfSBmcm9tIFwiLi9pdGVtXCI7XG5cbmV4cG9ydCBjb25zdCBtaWdyYXRlV29ybGQgPSBhc3luYyAoKSA9PiB7XG4gICAgY29uc3Qgc2NoZW1hVmVyc2lvbiA9IDE7XG4gICAgY29uc3Qgd29ybGRTY2hlbWFWZXJzaW9uID0gTnVtYmVyKGdhbWUuc2V0dGluZ3MuZ2V0KFwid3JhdGgtYW5kLWdsb3J5XCIsIFwid29ybGRTY2hlbWFWZXJzaW9uXCIpKTtcbiAgICBpZiAod29ybGRTY2hlbWFWZXJzaW9uICE9PSBzY2hlbWFWZXJzaW9uICYmIGdhbWUudXNlci5pc0dNKSB7XG4gICAgICAgIHVpLm5vdGlmaWNhdGlvbnMuaW5mbyhcIlVwZ3JhZGluZyB0aGUgd29ybGQsIHBsZWFzZSB3YWl0Li4uXCIpO1xuICAgICAgICBmb3IgKGxldCBhY3RvciBvZiBnYW1lLmFjdG9ycy5jb250ZW50cykge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb25zdCB1cGRhdGUgPSBtaWdyYXRlQWN0b3JEYXRhKGFjdG9yLmRhdGEsIHdvcmxkU2NoZW1hVmVyc2lvbik7XG4gICAgICAgICAgICAgICAgaWYgKCFpc09iamVjdEVtcHR5KHVwZGF0ZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgYWN0b3IudXBkYXRlKHVwZGF0ZSwge2VuZm9yY2VUeXBlczogZmFsc2V9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBmb3IgKGxldCBpdGVtIG9mIGdhbWUuaXRlbXMuY29udGVudHMpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdXBkYXRlID0gbWlncmF0ZUl0ZW1EYXRhKGl0ZW0uZGF0YSwgd29ybGRTY2hlbWFWZXJzaW9uKTtcbiAgICAgICAgICAgICAgICBpZiAoIWlzT2JqZWN0RW1wdHkodXBkYXRlKSkge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCBpdGVtLnVwZGF0ZSh1cGRhdGUsIHtlbmZvcmNlVHlwZXM6IGZhbHNlfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChsZXQgc2NlbmUgb2YgZ2FtZS5zY2VuZXMuY29udGVudHMpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdXBkYXRlID0gbWlncmF0ZVNjZW5lRGF0YShzY2VuZS5kYXRhLCB3b3JsZFNjaGVtYVZlcnNpb24pO1xuICAgICAgICAgICAgICAgIGlmICghaXNPYmplY3RFbXB0eSh1cGRhdGUpKSB7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHNjZW5lLnVwZGF0ZSh1cGRhdGUsIHtlbmZvcmNlVHlwZXM6IGZhbHNlfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGZvciAobGV0IHBhY2sgb2YgZ2FtZS5wYWNrcy5maWx0ZXIoKHA6IGFueSkgPT4gcC5tZXRhZGF0YS5wYWNrYWdlID09PSBcIndvcmxkXCIgJiYgW1wiQWN0b3JcIl0uaW5jbHVkZXMocC5tZXRhZGF0YS5lbnRpdHkpKSkge1xuICAgICAgICAgICAgYXdhaXQgbWlncmF0ZUNvbXBlbmRpdW0ocGFjaywgd29ybGRTY2hlbWFWZXJzaW9uKTtcbiAgICAgICAgfVxuICAgICAgICBnYW1lLnNldHRpbmdzLnNldChcIndyYXRoLWFuZC1nbG9yeVwiLCBcIndvcmxkU2NoZW1hVmVyc2lvblwiLCBzY2hlbWFWZXJzaW9uKTtcbiAgICAgICAgdWkubm90aWZpY2F0aW9ucy5pbmZvKFwiVXBncmFkZSBjb21wbGV0ZSFcIik7XG4gICAgfVxufTtcblxuY29uc3QgbWlncmF0ZUFjdG9yRGF0YSA9IChhY3RvcjogQWN0b3IsIHdvcmxkU2NoZW1hVmVyc2lvbjogbnVtYmVyKSA9PiB7XG4gICAgY29uc3QgdXBkYXRlOiBhbnkgPSB7fTtcbiAgICBpZiAod29ybGRTY2hlbWFWZXJzaW9uIDwgMSkge1xuICAgICAgICBpZiAoYWN0b3IudHlwZSA9PT0gXCJhZ2VudFwiIHx8IGFjdG9yLnR5cGUgPT09IFwidGhyZWF0XCIpIHtcbiAgICAgICAgICAgIHVwZGF0ZVtcImRhdGEuY29tYmF0LnN0ZWFsdGhcIl0gPSAwO1xuICAgICAgICB9XG4gICAgfVxuICAgIGxldCBpdGVtc0NoYW5nZWQgPSBmYWxzZTtcbiAgICBjb25zdCBpdGVtcyA9IGFjdG9yLml0ZW1zLm1hcCgoaXRlbSkgPT4ge1xuICAgICAgICBjb25zdCBpdGVtVXBkYXRlID0gbWlncmF0ZUl0ZW1EYXRhKGl0ZW0sIHdvcmxkU2NoZW1hVmVyc2lvbik7XG4gICAgICAgIGlmICghaXNPYmplY3RFbXB0eShpdGVtVXBkYXRlKSkge1xuICAgICAgICAgICAgaXRlbXNDaGFuZ2VkID0gdHJ1ZTtcbiAgICAgICAgICAgIHJldHVybiBtZXJnZU9iamVjdChpdGVtLCBpdGVtVXBkYXRlLCB7ZW5mb3JjZVR5cGVzOiBmYWxzZSwgaW5wbGFjZTogZmFsc2V9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gaXRlbTtcbiAgICB9KTtcbiAgICBpZiAoaXRlbXNDaGFuZ2VkKSB7XG4gICAgICAgIHVwZGF0ZS5pdGVtcyA9IGl0ZW1zO1xuICAgIH1cbiAgICByZXR1cm4gdXBkYXRlO1xufTtcblxuY29uc3QgbWlncmF0ZUl0ZW1EYXRhID0gKGl0ZW06IFdyYXRoQW5kR2xvcnlJdGVtLCB3b3JsZFNjaGVtYVZlcnNpb246IG51bWJlcikgPT4ge1xuICAgIGNvbnN0IHVwZGF0ZTogYW55ID0ge307XG4gICAgaWYgKHdvcmxkU2NoZW1hVmVyc2lvbiA8IDEpIHtcbiAgICAgICAgaWYgKGl0ZW0udHlwZSA9PT0gXCJ3ZWFwb25cIikge1xuICAgICAgICAgICAgdXBkYXRlW1wiZGF0YS5hdHRhY2tcIl0gPSB7XG4gICAgICAgICAgICAgICAgYmFzZTogMCxcbiAgICAgICAgICAgICAgICBib251czogMCxcbiAgICAgICAgICAgICAgICByYW5rOiBcIm5vbmVcIlxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHVwZGF0ZVtcImRhdGEuZGFtYWdlXCJdID0ge1xuICAgICAgICAgICAgICAgIGJhc2U6IGl0ZW0uZGF0YS5kYW1hZ2UsXG4gICAgICAgICAgICAgICAgYm9udXM6IDAsXG4gICAgICAgICAgICAgICAgcmFuazogXCJub25lXCJcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB1cGRhdGVbXCJkYXRhLmVkXCJdID0ge1xuICAgICAgICAgICAgICAgIGJhc2U6IGl0ZW0uZGF0YS5lZCxcbiAgICAgICAgICAgICAgICBib251czogMCxcbiAgICAgICAgICAgICAgICByYW5rOiBcIm5vbmVcIixcbiAgICAgICAgICAgICAgICBkaWU6IHtcbiAgICAgICAgICAgICAgICAgICAgb25lOiAwLFxuICAgICAgICAgICAgICAgICAgICB0d286IDAsXG4gICAgICAgICAgICAgICAgICAgIHRocmVlOiAwLFxuICAgICAgICAgICAgICAgICAgICBmb3VyOiAxLFxuICAgICAgICAgICAgICAgICAgICBmaXZlOiAxLFxuICAgICAgICAgICAgICAgICAgICBzaXg6IDIsXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHVwZGF0ZVtcImRhdGEuYXBcIl0gPSB7XG4gICAgICAgICAgICAgICAgYmFzZTogaXRlbS5kYXRhLmFwLFxuICAgICAgICAgICAgICAgIGJvbnVzOiAwLFxuICAgICAgICAgICAgICAgIHJhbms6IFwibm9uZVwiXG4gICAgICAgICAgICB9O1xuICAgICAgICB9IGVsc2UgaWYgKGl0ZW0udHlwZSA9PT0gXCJwc3ljaGljUG93ZXJcIikge1xuICAgICAgICAgICAgdXBkYXRlW1wiZGF0YS5kYW1hZ2VcIl0gPSB7XG4gICAgICAgICAgICAgICAgYmFzZTogMCxcbiAgICAgICAgICAgICAgICBib251czogMCxcbiAgICAgICAgICAgICAgICByYW5rOiBcIm5vbmVcIixcbiAgICAgICAgICAgICAgICBkaWU6IHtcbiAgICAgICAgICAgICAgICAgICAgb25lOiAwLFxuICAgICAgICAgICAgICAgICAgICB0d286IDAsXG4gICAgICAgICAgICAgICAgICAgIHRocmVlOiAwLFxuICAgICAgICAgICAgICAgICAgICBmb3VyOiAxLFxuICAgICAgICAgICAgICAgICAgICBmaXZlOiAxLFxuICAgICAgICAgICAgICAgICAgICBzaXg6IDIsXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHVwZGF0ZVtcImRhdGEuZWRcIl0gPSB7XG4gICAgICAgICAgICAgICAgYmFzZTogMCxcbiAgICAgICAgICAgICAgICBib251czogMCxcbiAgICAgICAgICAgICAgICByYW5rOiBcIm5vbmVcIlxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoIWlzT2JqZWN0RW1wdHkodXBkYXRlKSkge1xuICAgICAgICB1cGRhdGUuX2lkID0gaXRlbS5faWQ7XG4gICAgfVxuICAgIHJldHVybiB1cGRhdGU7XG59O1xuXG5jb25zdCBtaWdyYXRlU2NlbmVEYXRhID0gKHNjZW5lOiBTY2VuZSwgd29ybGRTY2hlbWFWZXJzaW9uOiBudW1iZXIpID0+IHtcbiAgICBjb25zdCB0b2tlbnM6IEFycmF5PFRva2VuRGF0YT4gPSBmb3VuZHJ5LnV0aWxzLmRlZXBDbG9uZShzY2VuZS50b2tlbnMpO1xuICAgIHJldHVybiB7XG4gICAgICAgIHRva2VuczogdG9rZW5zLm1hcCgodG9rZW5EYXRhKSA9PiB7XG4gICAgICAgICAgICBpZiAoIXRva2VuRGF0YS5hY3RvcklkIHx8IHRva2VuRGF0YS5hY3RvckxpbmsgfHwgIXRva2VuRGF0YS5hY3RvckRhdGEuZGF0YSkge1xuICAgICAgICAgICAgICAgIHRva2VuRGF0YS5hY3RvckRhdGEgPSB7fTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdG9rZW5EYXRhO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgdG9rZW4gPSBuZXcgVG9rZW4odG9rZW5EYXRhKTtcbiAgICAgICAgICAgIGlmICghdG9rZW4uYWN0b3IpIHtcbiAgICAgICAgICAgICAgICB0b2tlbkRhdGEuYWN0b3JJZCA9IG51bGw7XG4gICAgICAgICAgICAgICAgdG9rZW5EYXRhLmFjdG9yRGF0YSA9IHt9O1xuICAgICAgICAgICAgfSBlbHNlIGlmICghdG9rZW5EYXRhLmFjdG9yTGluayAmJiB0b2tlbi5kYXRhLmFjdG9yRGF0YS5pdGVtcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IHVwZGF0ZSA9IG1pZ3JhdGVBY3RvckRhdGEodG9rZW4uZGF0YS5hY3RvckRhdGEsIHdvcmxkU2NoZW1hVmVyc2lvbik7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJBQ1RPUiBDSEFOR0VEXCIsIHRva2VuLmRhdGEuYWN0b3JEYXRhLCB1cGRhdGUpO1xuICAgICAgICAgICAgICAgIHRva2VuRGF0YS5hY3RvckRhdGEgPSBtZXJnZU9iamVjdCh0b2tlbi5kYXRhLmFjdG9yRGF0YSwgdXBkYXRlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0b2tlbkRhdGE7XG4gICAgICAgIH0pLFxuICAgIH07XG59O1xuXG5leHBvcnQgY29uc3QgbWlncmF0ZUNvbXBlbmRpdW0gPSBhc3luYyBmdW5jdGlvbiAocGFjazogYW55LCB3b3JsZFNjaGVtYVZlcnNpb246IG51bWJlcikge1xuICAgIGNvbnN0IGVudGl0eSA9IHBhY2subWV0YWRhdGEuZW50aXR5O1xuXG4gICAgYXdhaXQgcGFjay5taWdyYXRlKCk7XG4gICAgY29uc3QgY29udGVudCA9IGF3YWl0IHBhY2suZ2V0Q29udGVudCgpO1xuXG4gICAgZm9yIChsZXQgZW50IG9mIGNvbnRlbnQpIHtcbiAgICAgICAgbGV0IHVwZGF0ZURhdGE6IGFueSA9IHt9O1xuICAgICAgICBpZiAoZW50aXR5ID09PSBcIkFjdG9yXCIpIHtcbiAgICAgICAgICAgIHVwZGF0ZURhdGEgPSBtaWdyYXRlQWN0b3JEYXRhKGVudC5kYXRhLCB3b3JsZFNjaGVtYVZlcnNpb24pO1xuICAgICAgICB9XG4gICAgICAgIGlmICghaXNPYmplY3RFbXB0eSh1cGRhdGVEYXRhKSkge1xuICAgICAgICAgICAgZXhwYW5kT2JqZWN0KHVwZGF0ZURhdGEpO1xuICAgICAgICAgICAgdXBkYXRlRGF0YVtcIl9pZFwiXSA9IGVudC5faWQ7XG4gICAgICAgICAgICBhd2FpdCBwYWNrLnVwZGF0ZUVudGl0eSh1cGRhdGVEYXRhKTtcbiAgICAgICAgfVxuICAgIH1cbn07Il19